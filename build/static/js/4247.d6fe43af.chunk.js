"use strict";(self.webpackChunkpromptheroready=self.webpackChunkpromptheroready||[]).push([[4247],{14247:(e,s,a)=>{a.r(s),a.d(s,{default:()=>S});var r=a(89379),i=a(9950),t=a(16255),l=a(60348),d=a(38493),c=a(14697),n=a(41591),o=a(95797),m=a(69293),h=a(32180),u=a(27549),x=a(21273),v=a(66987),g=a(52607),j=a(71742),p=a(13147),w=a(81946),b=a(81064),N=a(45536),f=a(15924),_=a(45833),y=a(40978),A=a(84814),k=a(7838),C=a(77737),E=a(44414);const S=()=>{const{adminUser:e,isSuperAdmin:s}=(0,h.z8)(),{toast:a}=(0,x.dj)(),[S,D]=(0,i.useState)([]),[L,U]=(0,i.useState)([]),[$,F]=(0,i.useState)(!0),[R,q]=(0,i.useState)(""),[z,Z]=(0,i.useState)(!1),[O,J]=(0,i.useState)(null),[M,W]=(0,i.useState)({email:"",role:"admin"});(0,i.useEffect)(()=>{s&&(I(),Y())},[s]);const I=async()=>{try{F(!0);const{data:e,error:s}=await u.ND.from("admin_users").select("\n          *,\n          user_email:user_id (email)\n        ").order("created_at",{ascending:!1});if(s)throw s;const a=(null===e||void 0===e?void 0:e.map(e=>{var s;return(0,r.A)((0,r.A)({},e),{},{user_email:(null===(s=e.user_email)||void 0===s?void 0:s.email)||"Unknown"})}))||[];D(a)}catch(e){console.error("Error fetching admin users:",e),a({title:"Error",description:"Failed to fetch admin users",variant:"destructive"})}finally{F(!1)}},Y=async()=>{try{const{data:e,error:s}=await u.ND.from("admin_audit_log").select("*").order("created_at",{ascending:!1}).limit(50);if(s)throw s;U(e||[])}catch(e){console.error("Error fetching audit logs:",e)}},B=async(s,a,r,i,t)=>{try{await u.ND.from("admin_audit_log").insert([{admin_user_id:null===e||void 0===e?void 0:e.id,action:s,resource_type:a,resource_id:r,old_values:i,new_values:t}])}catch(l){console.error("Error logging audit action:",l)}},G=()=>{W({email:"",role:"admin"})},V=S.filter(e=>{var s;return(null===(s=e.user_email)||void 0===s?void 0:s.toLowerCase().includes(R.toLowerCase()))||e.role.toLowerCase().includes(R.toLowerCase())}),T=e=>{switch(e){case"super_admin":return(0,E.jsx)(l.E,{className:"bg-purple-600/20 text-purple-400 border-purple-500/30",children:"Super Admin"});case"admin":return(0,E.jsx)(l.E,{className:"bg-blue-600/20 text-blue-400 border-blue-500/30",children:"Admin"});default:return(0,E.jsx)(l.E,{variant:"secondary",children:e})}};return s?$?(0,E.jsxs)("div",{className:"space-y-6",children:[(0,E.jsxs)("div",{className:"flex items-center justify-between",children:[(0,E.jsx)("h1",{className:"text-3xl font-bold text-white",children:"Role Management"}),(0,E.jsx)("div",{className:"animate-pulse h-8 w-32 bg-white/10 rounded"})]}),(0,E.jsx)("div",{className:"grid gap-6",children:[...Array(3)].map((e,s)=>(0,E.jsx)(t.Zp,{className:"workspace-card animate-pulse",children:(0,E.jsx)(t.Wu,{className:"p-6",children:(0,E.jsx)("div",{className:"h-24 bg-white/10 rounded"})})},s))})]}):(0,E.jsxs)("div",{className:"space-y-6",children:[(0,E.jsxs)("div",{className:"flex items-center justify-between",children:[(0,E.jsxs)("div",{children:[(0,E.jsx)("h1",{className:"text-3xl font-bold text-white",children:"Role Management"}),(0,E.jsx)("p",{className:"text-gray-400 mt-1",children:"Manage admin users and view audit logs"})]}),(0,E.jsxs)("div",{className:"flex items-center gap-2",children:[(0,E.jsxs)(d.$,{onClick:()=>{I(),Y()},variant:"outline",size:"sm",className:"border-white/20 text-white hover:bg-white/10",children:[(0,E.jsx)(v.A,{className:"mr-2 h-4 w-4"}),"Refresh"]}),(0,E.jsxs)(m.lG,{open:z,onOpenChange:Z,children:[(0,E.jsx)(m.zM,{asChild:!0,children:(0,E.jsxs)(d.$,{className:"bg-green-600 hover:bg-green-700 text-white",children:[(0,E.jsx)(g.A,{className:"mr-2 h-4 w-4"}),"Add Admin"]})}),(0,E.jsxs)(m.Cf,{className:"bg-black/90 backdrop-blur-xl border-white/10 text-white",children:[(0,E.jsx)(m.c7,{children:(0,E.jsx)(m.L3,{children:"Add New Admin User"})}),(0,E.jsxs)("div",{className:"space-y-4",children:[(0,E.jsxs)("div",{children:[(0,E.jsx)(n.J,{htmlFor:"email",children:"User Email"}),(0,E.jsx)(c.p,{id:"email",type:"email",value:M.email,onChange:e=>W(s=>(0,r.A)((0,r.A)({},s),{},{email:e.target.value})),className:"bg-black/20 border-white/20 text-white",placeholder:"user@example.com"})]}),(0,E.jsxs)("div",{children:[(0,E.jsx)(n.J,{htmlFor:"role",children:"Role"}),(0,E.jsxs)(o.l6,{value:M.role,onValueChange:e=>W(s=>(0,r.A)((0,r.A)({},s),{},{role:e})),children:[(0,E.jsx)(o.bq,{className:"bg-black/20 border-white/20 text-white",children:(0,E.jsx)(o.yv,{})}),(0,E.jsxs)(o.gC,{className:"bg-black/90 border-white/20",children:[(0,E.jsx)(o.eb,{value:"admin",children:"Admin"}),(0,E.jsx)(o.eb,{value:"super_admin",children:"Super Admin"})]})]})]}),(0,E.jsxs)("div",{className:"flex justify-end gap-2 pt-4",children:[(0,E.jsx)(d.$,{variant:"outline",onClick:()=>{Z(!1),G()},className:"border-white/20 text-white hover:bg-white/10",children:"Cancel"}),(0,E.jsxs)(d.$,{onClick:async()=>{try{const{data:s,error:r}=await u.ND.from("auth.users").select("id").eq("email",M.email).single();if(r)return void a({title:"Error",description:"User not found with that email address",variant:"destructive"});const{data:i,error:t}=await u.ND.from("admin_users").insert([{user_id:s.id,role:M.role,is_active:!0,created_by:null===e||void 0===e?void 0:e.id}]).select().single();if(t)throw t;await B("admin_created","admin_user",i.id,null,{role:M.role,email:M.email}),await I(),Z(!1),G(),a({title:"Success",description:"Admin user created successfully with ".concat(M.role," role")})}catch(s){console.error("Error creating admin user:",s),a({title:"Error",description:"Failed to create admin user",variant:"destructive"})}},className:"bg-green-600 hover:bg-green-700 text-white",disabled:!M.email,children:[(0,E.jsx)(j.A,{className:"mr-2 h-4 w-4"}),"Add Admin"]})]})]})]})]})]})]}),(0,E.jsx)(t.Zp,{className:"workspace-card",children:(0,E.jsx)(t.Wu,{className:"p-4",children:(0,E.jsxs)("div",{className:"relative",children:[(0,E.jsx)(p.A,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),(0,E.jsx)(c.p,{placeholder:"Search admin users...",value:R,onChange:e=>q(e.target.value),className:"pl-10 bg-black/20 border-white/20 text-white"})]})})}),(0,E.jsxs)(t.Zp,{className:"workspace-card",children:[(0,E.jsx)(t.aR,{children:(0,E.jsxs)(t.ZB,{className:"text-white flex items-center gap-2",children:[(0,E.jsx)(w.A,{className:"h-5 w-5 text-green-400"}),"Admin Users (",V.length,")"]})}),(0,E.jsx)(t.Wu,{children:(0,E.jsx)("div",{className:"space-y-4",children:0===V.length?(0,E.jsxs)("div",{className:"text-center py-8",children:[(0,E.jsx)(b.A,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,E.jsx)("h3",{className:"text-lg font-medium text-white mb-2",children:"No admin users found"}),(0,E.jsx)("p",{className:"text-gray-400",children:R?"Try adjusting your search":"Add your first admin user to get started"})]}):V.map(s=>{return(0,E.jsxs)("div",{className:"flex items-center justify-between p-4 bg-black/20 rounded-lg border border-white/10",children:[(0,E.jsxs)("div",{className:"flex items-center gap-4",children:[(0,E.jsx)("div",{className:"p-2 bg-green-600/20 rounded-lg",children:"super_admin"===s.role?(0,E.jsx)(N.A,{className:"h-5 w-5 text-purple-400"}):(0,E.jsx)(b.A,{className:"h-5 w-5 text-blue-400"})}),(0,E.jsxs)("div",{children:[(0,E.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,E.jsx)("p",{className:"text-white font-medium",children:s.user_email}),T(s.role),(r=s.is_active,r?(0,E.jsx)(l.E,{className:"bg-green-600/20 text-green-400 border-green-500/30",children:"Active"}):(0,E.jsx)(l.E,{className:"bg-red-600/20 text-red-400 border-red-500/30",children:"Inactive"})),s.user_id===(null===e||void 0===e?void 0:e.id)&&(0,E.jsx)(l.E,{variant:"outline",className:"text-xs border-yellow-500/30 text-yellow-400",children:"You"})]}),(0,E.jsxs)("div",{className:"flex items-center gap-4 text-xs text-gray-400",children:[(0,E.jsxs)("span",{children:["Created: ",new Date(s.created_at).toLocaleDateString()]}),s.last_login_at&&(0,E.jsxs)("span",{children:["Last login: ",new Date(s.last_login_at).toLocaleDateString()]})]})]})]}),(0,E.jsxs)("div",{className:"flex items-center gap-2",children:[(0,E.jsx)(d.$,{variant:"ghost",size:"sm",onClick:()=>(async s=>{if(s.user_id!==(null===e||void 0===e?void 0:e.id))try{const e=!s.is_active,{error:r}=await u.ND.from("admin_users").update({is_active:e,updated_at:(new Date).toISOString()}).eq("id",s.id);if(r)throw r;await B(e?"admin_activated":"admin_deactivated","admin_user",s.id,{is_active:s.is_active},{is_active:e}),await I(),a({title:"Success",description:"Admin user ".concat(e?"activated":"deactivated"," successfully")})}catch(r){console.error("Error toggling admin status:",r),a({title:"Error",description:"Failed to update admin status",variant:"destructive"})}else a({title:"Error",description:"You cannot deactivate your own account",variant:"destructive"})})(s),disabled:s.user_id===(null===e||void 0===e?void 0:e.id),className:"text-gray-400 hover:bg-white/10 ".concat(s.is_active?"hover:text-red-400":"hover:text-green-400"),children:s.is_active?(0,E.jsx)(f.A,{className:"h-4 w-4"}):(0,E.jsx)(_.A,{className:"h-4 w-4"})}),(0,E.jsx)(d.$,{variant:"ghost",size:"sm",onClick:()=>(e=>{J(e),W({email:e.user_email||"",role:e.role})})(s),className:"text-gray-400 hover:text-white hover:bg-white/10",children:(0,E.jsx)(y.A,{className:"h-4 w-4"})}),(0,E.jsx)(d.$,{variant:"ghost",size:"sm",onClick:()=>(async s=>{if(s.user_id!==(null===e||void 0===e?void 0:e.id)){if(confirm("Are you sure you want to delete admin access for ".concat(s.user_email,"?")))try{const{error:e}=await u.ND.from("admin_users").delete().eq("id",s.id);if(e)throw e;await B("admin_deleted","admin_user",s.id,{role:s.role,email:s.user_email},null),await I(),a({title:"Success",description:"Admin user deleted successfully"})}catch(r){console.error("Error deleting admin user:",r),a({title:"Error",description:"Failed to delete admin user",variant:"destructive"})}}else a({title:"Error",description:"You cannot delete your own account",variant:"destructive"})})(s),disabled:s.user_id===(null===e||void 0===e?void 0:e.id),className:"text-gray-400 hover:text-red-400 hover:bg-red-500/10",children:(0,E.jsx)(A.A,{className:"h-4 w-4"})})]})]},s.id);var r})})})]}),(0,E.jsxs)(t.Zp,{className:"workspace-card",children:[(0,E.jsx)(t.aR,{children:(0,E.jsxs)(t.ZB,{className:"text-white flex items-center gap-2",children:[(0,E.jsx)(k.A,{className:"h-5 w-5 text-green-400"}),"Recent Audit Logs"]})}),(0,E.jsx)(t.Wu,{children:(0,E.jsx)("div",{className:"space-y-3",children:0===L.length?(0,E.jsxs)("div",{className:"text-center py-8",children:[(0,E.jsx)(C.A,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,E.jsx)("h3",{className:"text-lg font-medium text-white mb-2",children:"No audit logs"}),(0,E.jsx)("p",{className:"text-gray-400",children:"Admin actions will be logged here"})]}):L.slice(0,10).map(e=>(0,E.jsxs)("div",{className:"flex items-center gap-3 p-3 bg-black/20 rounded-lg border border-white/10",children:[(0,E.jsx)("div",{className:"p-1.5 bg-blue-600/20 rounded",children:(0,E.jsx)(C.A,{className:"h-3 w-3 text-blue-400"})}),(0,E.jsxs)("div",{className:"flex-1",children:[(0,E.jsx)("p",{className:"text-white text-sm",children:e.action.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}),(0,E.jsxs)("p",{className:"text-gray-400 text-xs",children:[e.resource_type," \u2022 ",new Date(e.created_at).toLocaleString()]})]})]},e.id))})})]}),(0,E.jsx)(m.lG,{open:!!O,onOpenChange:e=>!e&&J(null),children:(0,E.jsxs)(m.Cf,{className:"bg-black/90 backdrop-blur-xl border-white/10 text-white",children:[(0,E.jsx)(m.c7,{children:(0,E.jsx)(m.L3,{children:"Edit Admin User"})}),(0,E.jsxs)("div",{className:"space-y-4",children:[(0,E.jsxs)("div",{children:[(0,E.jsx)(n.J,{children:"Email"}),(0,E.jsx)(c.p,{value:M.email,disabled:!0,className:"bg-black/20 border-white/20 text-gray-400"})]}),(0,E.jsxs)("div",{children:[(0,E.jsx)(n.J,{htmlFor:"edit-role",children:"Role"}),(0,E.jsxs)(o.l6,{value:M.role,onValueChange:e=>W(s=>(0,r.A)((0,r.A)({},s),{},{role:e})),children:[(0,E.jsx)(o.bq,{className:"bg-black/20 border-white/20 text-white",children:(0,E.jsx)(o.yv,{})}),(0,E.jsxs)(o.gC,{className:"bg-black/90 border-white/20",children:[(0,E.jsx)(o.eb,{value:"admin",children:"Admin"}),(0,E.jsx)(o.eb,{value:"super_admin",children:"Super Admin"})]})]})]}),(0,E.jsxs)("div",{className:"flex justify-end gap-2 pt-4",children:[(0,E.jsx)(d.$,{variant:"outline",onClick:()=>{J(null),G()},className:"border-white/20 text-white hover:bg-white/10",children:"Cancel"}),(0,E.jsxs)(d.$,{onClick:async()=>{if(O)try{const e={role:O.role,is_active:O.is_active},{data:s,error:r}=await u.ND.from("admin_users").update({role:M.role,updated_at:(new Date).toISOString()}).eq("id",O.id).select().single();if(r)throw r;await B("admin_updated","admin_user",O.id,e,{role:M.role}),await I(),J(null),G(),a({title:"Success",description:"Admin user updated successfully"})}catch(e){console.error("Error updating admin user:",e),a({title:"Error",description:"Failed to update admin user",variant:"destructive"})}},className:"bg-green-600 hover:bg-green-700 text-white",children:[(0,E.jsx)(j.A,{className:"mr-2 h-4 w-4"}),"Update Admin"]})]})]})]})})]}):(0,E.jsxs)("div",{className:"text-center text-white",children:[(0,E.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"Access Denied"}),(0,E.jsx)("p",{children:"Only Super Admins can access role management."})]})}}}]);